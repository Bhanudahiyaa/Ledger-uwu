{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport React from 'react';\nimport { useXFlowApp, getNodeReactComponent } from '@antv/xflow-core';\nimport { Addon } from '@antv/x6';\nimport { XFlowNode } from '../../canvas-dag-extension/x6-extension/node';\nexport const defaultNodeFactory = args => {\n  return new XFlowNode(args);\n};\nexport const useGraphDnd = props => {\n  const {\n    x6NodeFactory,\n    dndOptions,\n    onNodeDrop\n  } = props;\n  const {\n    graphProvider,\n    modelService,\n    commandService\n  } = useXFlowApp();\n  const [graphConfig, setConfig] = React.useState();\n  const [dnd, setDnd] = React.useState();\n  const [graph, setGraph] = React.useState();\n  /** 引用 graph 配置 */\n  React.useEffect(() => {\n    graphProvider.getGraphInstance().then(x6Graph => {\n      setGraph(x6Graph);\n    });\n    graphProvider.getGraphOptions().then(x6GraphConfig => {\n      setConfig(x6GraphConfig);\n    });\n  }, [graphProvider, setGraph, setConfig]);\n  /** 初始化 Dnd 实例 */\n  React.useEffect(() => {\n    if (!graph) {\n      return;\n    }\n    const dndInstance = new Addon.Dnd(Object.assign(Object.assign({\n      scaled: false,\n      animation: false\n    }, dndOptions), {\n      target: graph,\n      /** 这里考虑到需要新增群组的需求，不使用x6的getDropNod方法\n       * 在validateNode时调用command添加\n       */\n      validateNode: droppingNode => __awaiter(void 0, void 0, void 0, function* () {\n        const nodeConfig = Object.assign(Object.assign({}, droppingNode.getData()), droppingNode.getPosition());\n        if (onNodeDrop) {\n          yield onNodeDrop(nodeConfig, commandService, modelService);\n        } else {\n          console.error('onNodeDrop method is required in NodeTree Panel');\n        }\n        return false;\n      })\n    }));\n    setDnd(dndInstance);\n    return () => {\n      dndInstance.dispose();\n    };\n  }, [commandService, modelService, dndOptions, graph, onNodeDrop]);\n  /** 开始拖拽 */\n  const onMouseDown = React.useCallback(nodeConfig => e => {\n    if (!graph || !dnd || !graphConfig) {\n      return;\n    }\n    if (nodeConfig.isDisabled) {\n      return;\n    }\n    // 获取节点组件\n    const renderKey = graphConfig.nodeTypeParser(nodeConfig);\n    const reactComponent = nodeConfig.renderComponent ? nodeConfig.renderComponent : graphConfig.nodeRender.get(renderKey);\n    // 包裹节点组件\n    const wrappedComponent = getNodeReactComponent(reactComponent, commandService, modelService);\n    const nodeData = {\n      data: nodeConfig,\n      width: nodeConfig.width || 180,\n      height: nodeConfig.height || 40,\n      view: graphConfig.graphId,\n      component: wrappedComponent\n    };\n    const x6Node = x6NodeFactory ? x6NodeFactory(nodeData) : defaultNodeFactory(nodeData);\n    dnd.start(x6Node, e.nativeEvent);\n  }, [commandService, dnd, graph, graphConfig, modelService, x6NodeFactory]);\n  return {\n    graphConfig,\n    onMouseDown,\n    modelService,\n    commandService\n  };\n};","map":{"version":3,"names":["React","useXFlowApp","getNodeReactComponent","Addon","XFlowNode","defaultNodeFactory","args","useGraphDnd","props","x6NodeFactory","dndOptions","onNodeDrop","graphProvider","modelService","commandService","graphConfig","setConfig","useState","dnd","setDnd","graph","setGraph","useEffect","getGraphInstance","then","x6Graph","getGraphOptions","x6GraphConfig","dndInstance","Dnd","Object","assign","scaled","animation","target","validateNode","droppingNode","__awaiter","nodeConfig","getData","getPosition","console","error","dispose","onMouseDown","useCallback","e","isDisabled","renderKey","nodeTypeParser","reactComponent","renderComponent","nodeRender","get","wrappedComponent","nodeData","data","width","height","view","graphId","component","x6Node","start","nativeEvent"],"sources":["../../../src/canvas-collapse-panel/panel-body/dnd-hook.tsx"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}