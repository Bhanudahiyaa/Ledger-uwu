{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport React from 'react';\nimport {\n// utils\nDisposable,\n// context\nuseXFlowApp,\n// models\nMODELS, createComponentModel,\n// commands\nXFlowModelCommands } from '@antv/xflow-core';\nimport { NsCollapsePanelModel } from './interface';\n/** 方便其他组件执行Command改变Panel内部状态 */\nexport const executeCollapsePanelCommand = (cmds, updateModel) => {\n  cmds.executeCommand(XFlowModelCommands.UPDATE_MODEL.id, {\n    getModel: modelService => __awaiter(void 0, void 0, void 0, function* () {\n      // eslint-disable-next-line react-hooks/rules-of-hooks\n      return NsCollapsePanelModel.useModel(modelService);\n    }),\n    updateModel: updateModel\n  });\n};\n/** 方便其他组件执行Command改变Panel内部状态 */\nexport const useCollapsePanelData = props => {\n  const {\n    collapsible,\n    nodeDataService,\n    searchService,\n    onCollapseChange\n  } = props;\n  const {\n    modelService\n  } = useXFlowApp();\n  /** 创建model */\n  const [state, setState, panelModel] = createComponentModel({\n    /** service: onKeywordChange */\n    keyword: '',\n    /** 展开的key id */\n    collapseData: [],\n    /** 搜索结果 */\n    searchResult: []\n  });\n  /** 注册model成为全局状态，方便其他组件联动 */\n  React.useEffect(() => {\n    if (modelService.findDeferredModel(NsCollapsePanelModel.id)) {\n      return;\n    }\n    modelService.registerModel({\n      id: NsCollapsePanelModel.id,\n      modelFactory: () => panelModel,\n      watchChange: self => __awaiter(void 0, void 0, void 0, function* () {\n        const graphMetaModel = yield MODELS.GRAPH_META.getModel(modelService); //useContext(MODELS.GRAPH_META.id)\n        const fetch = meta => __awaiter(void 0, void 0, void 0, function* () {\n          const data = yield nodeDataService(meta, modelService);\n          return {\n            collapseData: data\n          };\n        });\n        const graphMetaDisposable = graphMetaModel.watch(meta => __awaiter(void 0, void 0, void 0, function* () {\n          const {\n            collapseData\n          } = yield fetch(meta);\n          self.setValue(m => {\n            m.keyword = '';\n            m.collapseData = collapseData;\n            m.searchResult = [];\n          });\n        }));\n        return Disposable.create(() => {\n          graphMetaDisposable.dispose();\n        });\n      })\n    });\n    /* eslint-disable-next-line  */\n  }, []);\n  /** 折叠文件夹 */\n  const onActiveKeyChange = React.useCallback(activeKey => {\n    setState(modelState => {\n      modelState.collapseData.forEach(item => {\n        if (item.id === activeKey && item.collapsible !== false) {\n          item.isCollapsed = !item.isCollapsed;\n        }\n      });\n    });\n  }, [setState]);\n  /** 搜索 */\n  const onKeywordChange = React.useCallback((keyword, panelNodes) => __awaiter(void 0, void 0, void 0, function* () {\n    if (!searchService) {\n      return console.warn('searchService is not defined');\n    }\n    if (keyword) {\n      const searchResult = yield searchService(panelNodes, keyword);\n      setState(modelState => {\n        modelState.keyword = keyword;\n        modelState.searchResult = searchResult;\n      });\n    } else {\n      setState(modelState => {\n        modelState.keyword = '';\n        modelState.searchResult = [];\n      });\n    }\n  }),\n  // eslint-disable-next-line\n  [searchService]);\n  return {\n    state,\n    collapsible,\n    setState,\n    onKeywordChange,\n    onActiveKeyChange,\n    onCollapseChange\n  };\n};","map":{"version":3,"names":["React","Disposable","useXFlowApp","MODELS","createComponentModel","XFlowModelCommands","NsCollapsePanelModel","executeCollapsePanelCommand","cmds","updateModel","executeCommand","UPDATE_MODEL","id","getModel","modelService","__awaiter","useModel","useCollapsePanelData","props","collapsible","nodeDataService","searchService","onCollapseChange","state","setState","panelModel","keyword","collapseData","searchResult","useEffect","findDeferredModel","registerModel","modelFactory","watchChange","self","graphMetaModel","GRAPH_META","fetch","meta","data","graphMetaDisposable","watch","setValue","m","create","dispose","onActiveKeyChange","useCallback","activeKey","modelState","forEach","item","isCollapsed","onKeywordChange","panelNodes","console","warn"],"sources":["../../src/canvas-collapse-panel/service.tsx"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}