{"ast":null,"code":"import { __decorate, __metadata } from \"tslib\";\nimport 'reflect-metadata';\nimport { singleton, inject, contrib, Contribution } from 'mana-syringe';\nimport debounce from 'lodash/debounce';\nimport cloneDeep from 'lodash/cloneDeep';\nimport isBoolean from 'lodash/isBoolean';\nimport { Disposable, DisposableCollection } from '../common/disposable';\nimport { IFrontendApplicationContribution } from '../xflow-main/interface';\nimport { RxModel } from '../common/rx-model';\nimport { IGraphCommandService } from '../command';\nimport { IModelService } from '../model-service';\nimport { IToolbarService, IToolbarContribution } from './interface';\n/**\n * Main, shared registry for toolbar items.\n */\nlet ToolbarRegistry = class ToolbarRegistry {\n  constructor() {\n    /** disposables */\n    this.toDispose = new DisposableCollection();\n    /** 储存所有toolbar items */\n    this.toolbarItems = new Map();\n    /** 注册ToolbarRegistry的onChange的事件 */\n    this.onDidChangeEvent = new RxModel(null);\n    /** 通过ToolbarRegistry.onDidChange监听ToolbarRegistry items的变化  */\n    this.onDidChange = this.onDidChangeEvent.watch;\n    /** debounce in order to avoid to fire more than once in the same tick */\n    this.fireOnDidChange = debounce(() => this.onDidChangeEvent.setValue(undefined), 16);\n    /**\n     * 批量注册可单独dispose的扩展项目\n     * @param externalRegisterFn IRegisterMenuFunction\n     */\n    this.registerDisposableToolbar = externalRegisterFn => {\n      const toDispose = new DisposableCollection();\n      const disposableRegistry = {\n        registerToolbarItem: config => {\n          const disposable = this.registerItem(config);\n          toDispose.push(disposable);\n          return disposable;\n        }\n      };\n      externalRegisterFn(disposableRegistry);\n      this.toDispose.push(toDispose);\n      return toDispose;\n    };\n    /**\n     * 获取 ToolbarModel\n     * @param toolbarConfig IToolbarOptions\n     */\n    this.getToolbarModel = toolbarConfig => {\n      const {\n        layout,\n        mainGroups = [],\n        extraGroups = []\n      } = toolbarConfig;\n      return new RxModel({\n        layout,\n        mainGroups: this.createToolbarGroupModel(mainGroups),\n        extraGroups: this.createToolbarGroupModel(extraGroups)\n      });\n    };\n    /**\n     * 创建 ToolbarModel\n     * @param groups IToolbarGroupOptions[]\n     */\n    this.createToolbarGroupModel = groups => {\n      const groupModels = groups.map(group => {\n        const {\n          items = []\n        } = group;\n        return Object.assign(Object.assign({}, group), {\n          items: items.map(item => this.createToolbarModel({\n            id: item.id\n          })).filter(i => !!i)\n        });\n      });\n      return groupModels;\n    };\n  }\n  /** App启动时，收集Toolbar扩展点的注册项 */\n  onStart() {\n    const contributions = this.contributionProvider.getContributions();\n    for (const contribution of contributions) {\n      contribution.registerToolbarItems(this);\n    }\n  }\n  /**\n   * App 销毁时调用\n   * dispose toolbarProvider\n   */\n  onStop() {\n    this.toDispose.dispose();\n  }\n  /**\n   * 注册ToolbarItem\n   * item所需的command需要提前在command registry注册\n   * @param config IToolbarItem\n   */\n  registerItem(config) {\n    if (this.toolbarItems.has(config.id)) {\n      console.warn(`ToolbarRegistry ${config.id} is duplicated, in`, config);\n    }\n    /** 注册 */\n    this.toolbarItems.set(config.id, config);\n    /** 通知更新 */\n    this.fireOnDidChange();\n    const toDispose = new DisposableCollection(Disposable.create(() => this.fireOnDidChange()), Disposable.create(() => this.toolbarItems.delete(config.id)));\n    return toDispose;\n  }\n  /**\n   * 创建 ToolbarModel\n   * @param option IToolbarItem\n   */\n  createToolbarModel(option) {\n    const item = cloneDeep(this.toolbarItems.get(option.id));\n    const isEnabled = isBoolean(item.isEnabled) ? item.isEnabled : true;\n    const isVisible = isBoolean(item.isVisible) ? item.isVisible : true;\n    const toolbarItem = Object.assign(Object.assign({}, item), {\n      isEnabled: isEnabled,\n      isVisible: isVisible,\n      iconName: item.iconName,\n      text: item.text\n    });\n    return toolbarItem;\n  }\n};\n__decorate([inject(IGraphCommandService), __metadata(\"design:type\", Object)], ToolbarRegistry.prototype, \"commandService\", void 0);\n__decorate([inject(IModelService), __metadata(\"design:type\", Object)], ToolbarRegistry.prototype, \"modelService\", void 0);\n__decorate([contrib(IToolbarContribution), __metadata(\"design:type\", Object)], ToolbarRegistry.prototype, \"contributionProvider\", void 0);\nToolbarRegistry = __decorate([singleton({\n  contrib: [IFrontendApplicationContribution, IToolbarService]\n})], ToolbarRegistry);\nexport { ToolbarRegistry };","map":{"version":3,"names":["singleton","inject","contrib","Contribution","debounce","cloneDeep","isBoolean","Disposable","DisposableCollection","IFrontendApplicationContribution","RxModel","IGraphCommandService","IModelService","IToolbarService","IToolbarContribution","ToolbarRegistry","constructor","toDispose","toolbarItems","Map","onDidChangeEvent","onDidChange","watch","fireOnDidChange","setValue","undefined","registerDisposableToolbar","externalRegisterFn","disposableRegistry","registerToolbarItem","config","disposable","registerItem","push","getToolbarModel","toolbarConfig","layout","mainGroups","extraGroups","createToolbarGroupModel","groups","groupModels","map","group","items","Object","assign","item","createToolbarModel","id","filter","i","onStart","contributions","contributionProvider","getContributions","contribution","registerToolbarItems","onStop","dispose","has","console","warn","set","create","delete","option","get","isEnabled","isVisible","toolbarItem","iconName","text","__decorate"],"sources":["../../src/toolbar/toolbar-registry.tsx"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}