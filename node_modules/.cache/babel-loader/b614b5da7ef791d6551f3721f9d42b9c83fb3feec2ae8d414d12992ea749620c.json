{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport React from 'react';\nimport { useXFlowApp, DisposableCollection, createComponentModel } from '@antv/xflow-core';\nimport { XFlowModelCommands, Disposable, MODELS } from '@antv/xflow-core';\nexport var NsJsonSchemaFormModel;\n(function (NsJsonSchemaFormModel) {\n  NsJsonSchemaFormModel.id = 'XFLOW_JSON_SCHEMA_FORM';\n  NsJsonSchemaFormModel.useModel = model => __awaiter(this, void 0, void 0, function* () {\n    return model.awaitModel(NsJsonSchemaFormModel.id);\n  });\n})(NsJsonSchemaFormModel || (NsJsonSchemaFormModel = {}));\n/** 方便其他组件执行Command改变Panel内部状态 */\nexport const executeJsonSchemaFormCommand = (cmds, updateModel) => {\n  cmds.executeCommand(XFlowModelCommands.UPDATE_MODEL.id, {\n    getModel: modelService => __awaiter(void 0, void 0, void 0, function* () {\n      // eslint-disable-next-line react-hooks/rules-of-hooks\n      return NsJsonSchemaFormModel.useModel(modelService);\n    }),\n    updateModel: updateModel\n  });\n};\nexport const useJsonSchemaFormModel = props => {\n  const app = useXFlowApp();\n  const {\n    commandService,\n    modelService,\n    getGraphInstance\n  } = app;\n  const {\n    formSchemaService\n  } = props;\n  const [state, setState, model, isModelReady] = createComponentModel({\n    schema: {\n      tabs: []\n    },\n    targetType: null,\n    targetData: null,\n    targetCell: null,\n    loading: false\n  });\n  /** 注册全局的model */\n  React.useEffect(() => {\n    if (!app || !app.modelService) {\n      return;\n    }\n    const toDispose = new DisposableCollection();\n    const deferredModel = app.modelService.findDeferredModel(NsJsonSchemaFormModel.id);\n    if (!deferredModel) {\n      const d = app.modelService.registerModel({\n        id: NsJsonSchemaFormModel.id,\n        modelFactory: () => model,\n        /** 监听SELECTED_CELL的变化 */\n        watchChange: (self, modelSerccie) => __awaiter(void 0, void 0, void 0, function* () {\n          const selectedCellModel = yield MODELS.SELECTED_CELL.getModel(modelSerccie);\n          const nodeDisposable = selectedCellModel.watch(cell => __awaiter(void 0, void 0, void 0, function* () {\n            const updateState = (targetCell, type) => __awaiter(void 0, void 0, void 0, function* () {\n              self.setValue(m => {\n                m.loading = true;\n                m.schema = {\n                  tabs: []\n                };\n                m.targetType = null;\n                m.targetData = null;\n                m.targetCell = null;\n              });\n              const targetData = targetCell ? targetCell.getData() : null;\n              if (!formSchemaService) {\n                return;\n              }\n              const graph = yield getGraphInstance();\n              const schema = yield formSchemaService({\n                commandService,\n                modelService,\n                targetData,\n                cell: targetCell,\n                targetType: type,\n                graph\n              });\n              self.setValue({\n                loading: false,\n                schema: schema,\n                targetType: type,\n                targetCell: targetCell,\n                targetData: targetData\n              });\n            });\n            const getCellType = targetCell => {\n              if (!targetCell) {\n                return 'canvas';\n              } else if (targetCell.isNode && targetCell.isNode() && targetCell.getProp('isGroup')) {\n                return 'group';\n              } else if (targetCell.isNode && targetCell.isNode()) {\n                return 'node';\n              } else if (targetCell.isEdge && targetCell.isEdge()) {\n                return 'edge';\n              } else {\n                return 'canvas';\n              }\n            };\n            const targetCellType = getCellType(cell);\n            if ((props.targetType || ['node', 'canvas']).includes(targetCellType)) {\n              yield updateState(cell, targetCellType);\n            }\n          }));\n          return Disposable.create(() => {\n            nodeDisposable.dispose();\n            toDispose.push(nodeDisposable);\n          });\n        })\n      });\n      toDispose.push(d);\n    }\n    return () => {\n      toDispose.dispose();\n    };\n    /* eslint-disable-next-line  */\n  }, []);\n  return {\n    commandService,\n    modelService,\n    state,\n    setState,\n    model,\n    isModelReady\n  };\n};","map":{"version":3,"names":["React","useXFlowApp","DisposableCollection","createComponentModel","XFlowModelCommands","Disposable","MODELS","NsJsonSchemaFormModel","id","useModel","model","__awaiter","awaitModel","executeJsonSchemaFormCommand","cmds","updateModel","executeCommand","UPDATE_MODEL","getModel","modelService","useJsonSchemaFormModel","props","app","commandService","getGraphInstance","formSchemaService","state","setState","isModelReady","schema","tabs","targetType","targetData","targetCell","loading","useEffect","toDispose","deferredModel","findDeferredModel","d","registerModel","modelFactory","watchChange","self","modelSerccie","selectedCellModel","SELECTED_CELL","nodeDisposable","watch","cell","updateState","type","setValue","m","getData","graph","getCellType","isNode","getProp","isEdge","targetCellType","includes","create","dispose","push"],"sources":["../../src/canvas-json-schema-form/service.tsx"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}