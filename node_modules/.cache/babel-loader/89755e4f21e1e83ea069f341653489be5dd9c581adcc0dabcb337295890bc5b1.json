{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport { BehaviorSubject, asyncScheduler } from 'rxjs';\nimport { throttleTime, filter, distinctUntilChanged } from 'rxjs/operators';\nimport { Disposable, DisposableCollection } from './disposable';\nimport { produce, setAutoFreeze, enableMapSet } from 'immer';\nimport { Deferred } from './deferred';\n// docs:https://immerjs.github.io/immer/map-set\nenableMapSet();\n// https://immerjs.github.io/immer/freezing\nsetAutoFreeze(false);\nexport var NsModel;\n(function (NsModel) {\n  /**\n   * observable 空值，当作model ready的变量\n   * 空值不会触发subscrition\n   */\n  NsModel.EMPTY_VALUE = Symbol('EMPTY_MODEL_VALUE');\n  /** 判断是否是空 */\n  function isValidValue(val) {\n    return val !== NsModel.EMPTY_VALUE;\n  }\n  NsModel.isValidValue = isValidValue;\n  /** 默认的对事件性能优化方法：只在value不同时才触发，同时增加throttle */\n  function defaultPipeFunction(observable) {\n    return observable.pipe(distinctUntilChanged(), filter(item => isValidValue(item)), throttleTime(17, asyncScheduler, {\n      leading: false,\n      trailing: true\n    }));\n  }\n  NsModel.defaultPipeFunction = defaultPipeFunction;\n})(NsModel || (NsModel = {}));\nexport class RxModel {\n  /** 初始化 */\n  constructor(initialValue = NsModel.EMPTY_VALUE, maxSubscription = 30) {\n    /** disposable */\n    this.toDispose = new DisposableCollection();\n    /** 监听model变化 */\n    this.watch = (cb, pipeFunction = NsModel.defaultPipeFunction) => {\n      if (this.subject$.observers.length + 1 > this.maxSubscription) {\n        console.warn(`${this.subject$} reach maxSubscription limitation, please check`);\n      }\n      const observable = pipeFunction ? pipeFunction(this.subject$) : this.subject$;\n      const subscription = observable.subscribe(cb);\n      return Disposable.create(() => {\n        subscription.unsubscribe();\n      });\n    };\n    /** 获取model的值 */\n    this.getValue = () => {\n      return this.subject$.getValue();\n    };\n    /** 更新model */\n    this.setValue = value => {\n      if (!this.subject$) {\n        return;\n      }\n      if (typeof value === 'function') {\n        const currentValue = this.subject$.getValue();\n        const nextState = produce(currentValue, draft => {\n          value(draft);\n        });\n        if (NsModel.isValidValue(nextState)) {\n          this.setValue(nextState);\n        }\n        return;\n      }\n      this.subject$.next(value);\n    };\n    /** 是否已有值 */\n    this.hasValidValue = () => {\n      const value = this.getValue();\n      return NsModel.isValidValue(value);\n    };\n    /** 获取非空的值 */\n    this.getValidValue = () => __awaiter(this, void 0, void 0, function* () {\n      const deffer = new Deferred();\n      /** 返回非空的值 */\n      if (this.hasValidValue()) {\n        return this.getValue();\n      }\n      /** 返回会resolve非空值的Promise */\n      const d = this.watch(val => {\n        if (NsModel.isValidValue(val)) {\n          deffer.resolve(val);\n          d.dispose();\n        }\n      });\n      return deffer.promise;\n    });\n    /** disposable */\n    this.dispose = () => {\n      this.toDispose.dispose();\n    };\n    this.subject$ = new BehaviorSubject(initialValue || NsModel.EMPTY_VALUE);\n    this.maxSubscription = maxSubscription;\n    this.toDispose.push(Disposable.create(() => {\n      this.subject$.complete();\n      this.subject$.unsubscribe();\n      // @ts-ignore\n      this.subject$ = null;\n    }));\n  }\n}","map":{"version":3,"names":["BehaviorSubject","asyncScheduler","throttleTime","filter","distinctUntilChanged","Disposable","DisposableCollection","produce","setAutoFreeze","enableMapSet","Deferred","NsModel","EMPTY_VALUE","Symbol","isValidValue","val","defaultPipeFunction","observable","pipe","item","leading","trailing","RxModel","constructor","initialValue","maxSubscription","toDispose","watch","cb","pipeFunction","subject$","observers","length","console","warn","subscription","subscribe","create","unsubscribe","getValue","setValue","value","currentValue","nextState","draft","next","hasValidValue","getValidValue","__awaiter","deffer","d","resolve","dispose","promise","push","complete"],"sources":["../../src/common/rx-model.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}