{"ast":null,"code":"import { __awaiter, __decorate, __metadata } from \"tslib\";\nimport { inject, injectable, postConstruct } from 'mana-syringe';\nimport { XFlowGroupCommands } from '../constant';\nimport { Disposable } from '../../common/disposable';\nimport { ICommandHandler, ICommandContextProvider } from '../../command/interface';\nimport { XFLOW_GROUP_DEFAULT_COLLAPSED_SIZE } from '../../constants';\nexport var NsCollapseGroup;\n(function (NsCollapseGroup) {\n  NsCollapseGroup.command = XFlowGroupCommands.COLLAPSE_GROUP;\n  NsCollapseGroup.hookKey = 'collapseGroup';\n})(NsCollapseGroup || (NsCollapseGroup = {}));\nlet CollapseGroupCommand = class CollapseGroupCommand {\n  constructor() {\n    this.toggleVisible = (cells, visible, graph) => {\n      cells.forEach(cell => {\n        const view = graph.findViewByCell(cell).container;\n        view.style.visibility = visible ? 'visible' : 'hidden';\n      });\n    };\n    this.toggleCollapse = (groupNode, graph, args) => {\n      const childrens = groupNode.getChildren().filter(n => n.isNode());\n      const groupData = groupNode.getData();\n      const {\n        isCollapsed,\n        gap = 0\n      } = args;\n      if (isCollapsed) {\n        const collapsedSize = args.collapsedSize || groupData.groupCollapsedSize || XFLOW_GROUP_DEFAULT_COLLAPSED_SIZE;\n        groupNode.prop('previousSize', groupNode.size());\n        groupNode.size(collapsedSize);\n      } else {\n        groupNode.size(groupNode.prop('previousSize'));\n      }\n      if (childrens) {\n        childrens.forEach(item => {\n          const position = groupNode.position();\n          const innerEdges = graph.getConnectedEdges(item).filter(edge => {\n            const sourceNode = edge.getSourceNode();\n            const targetNode = edge.getTargetNode();\n            return childrens.includes(sourceNode) && childrens.includes(targetNode);\n          });\n          if (isCollapsed) {\n            this.toggleVisible([item, ...innerEdges], false, graph);\n            item.prop('previousSize', item.size());\n            item.prop('previousRelativePosition', item.position({\n              relative: true\n            }));\n            item.position(position.x + gap, position.y + gap);\n            const size = groupNode.size();\n            item.size({\n              width: size.width - gap * 2,\n              height: size.height - gap * 2\n            });\n          } else {\n            this.toggleVisible([item, ...innerEdges], true, graph);\n            const pos = item.prop('previousRelativePosition');\n            const size = item.prop('previousSize');\n            item.position(pos.x, pos.y, {\n              relative: true\n            });\n            item.size(size);\n          }\n        });\n      }\n      groupNode.prop('isCollapsed', isCollapsed);\n      groupNode.setData(Object.assign(Object.assign({}, groupNode.getData()), {\n        isCollapsed\n      }));\n    };\n    this.execute = () => __awaiter(this, void 0, void 0, function* () {\n      const {\n        args,\n        hooks: runtimeHook\n      } = this.ctx.getArgs();\n      const hooks = this.ctx.getHooks();\n      const result = yield hooks.collapseGroup.call(args, handlerArgs => __awaiter(this, void 0, void 0, function* () {\n        const x6Graph = yield this.ctx.getX6Graph();\n        const node = x6Graph.getCellById(args.nodeId);\n        const {\n          toggleService\n        } = handlerArgs;\n        if (toggleService) {\n          const canToggle = yield toggleService(handlerArgs);\n          if (!canToggle) return {\n            err: 'service rejected'\n          };\n        }\n        if (node) {\n          this.toggleCollapse(node, x6Graph, args);\n          this.ctx.addUndo(Disposable.create(() => __awaiter(this, void 0, void 0, function* () {\n            if (node) {\n              this.toggleCollapse(node, x6Graph, Object.assign(args, {\n                isCollapsed: !args.isCollapsed\n              }));\n            }\n          })));\n        }\n        return {\n          err: null\n        };\n      }), runtimeHook);\n      this.ctx.setResult(result);\n      return this;\n    });\n    this.undo = () => __awaiter(this, void 0, void 0, function* () {\n      this.ctx.undo();\n      return this;\n    });\n    this.redo = () => __awaiter(this, void 0, void 0, function* () {\n      if (!this.ctx.isUndoable) {\n        yield this.execute();\n      }\n      return this;\n    });\n  }\n  init() {\n    this.ctx = this.contextProvider();\n  }\n  isUndoable() {\n    return this.ctx.isUndoable();\n  }\n};\n__decorate([inject(ICommandContextProvider), __metadata(\"design:type\", Object)], CollapseGroupCommand.prototype, \"contextProvider\", void 0);\n__decorate([postConstruct(), __metadata(\"design:type\", Function), __metadata(\"design:paramtypes\", []), __metadata(\"design:returntype\", void 0)], CollapseGroupCommand.prototype, \"init\", null);\nCollapseGroupCommand = __decorate([injectable({\n  token: {\n    token: ICommandHandler,\n    named: NsCollapseGroup.command.id\n  }\n})\n/** 添加子节点命令 */], CollapseGroupCommand);\nexport { CollapseGroupCommand };","map":{"version":3,"names":["inject","injectable","postConstruct","XFlowGroupCommands","Disposable","ICommandHandler","ICommandContextProvider","XFLOW_GROUP_DEFAULT_COLLAPSED_SIZE","NsCollapseGroup","command","COLLAPSE_GROUP","hookKey","CollapseGroupCommand","constructor","toggleVisible","cells","visible","graph","forEach","cell","view","findViewByCell","container","style","visibility","toggleCollapse","groupNode","args","childrens","getChildren","filter","n","isNode","groupData","getData","isCollapsed","gap","collapsedSize","groupCollapsedSize","prop","size","item","position","innerEdges","getConnectedEdges","edge","sourceNode","getSourceNode","targetNode","getTargetNode","includes","relative","x","y","width","height","pos","setData","Object","assign","execute","__awaiter","hooks","runtimeHook","ctx","getArgs","getHooks","result","collapseGroup","call","handlerArgs","x6Graph","getX6Graph","node","getCellById","nodeId","toggleService","canToggle","err","addUndo","create","setResult","undo","redo","isUndoable","init","contextProvider","__decorate","token","named","id"],"sources":["../../../src/command-contributions/group/group-toggle-collapse.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}