{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport { ScheduleTypeEnum } from './interface';\nimport { ErrorUtils, HookUtils, Deferred } from './utils';\nexport { ScheduleTypeEnum } from './interface';\nexport class HookHub {\n  constructor(options) {\n    /** scheduleType */\n    this.scheduleType = ScheduleTypeEnum.ASYNC_SRRIES;\n    /** hasRegistered */\n    this.hasHook = hookName => {\n      return this.hookMap.has(hookName);\n    };\n    /** getHooks */\n    this.getHooks = (runtimeHooks = [], sort = true) => {\n      const hooks = HookUtils.normalize(runtimeHooks, this.hookMap);\n      if (!sort) {\n        return hooks;\n      }\n      return HookUtils.sort(hooks, this.hookMap);\n    };\n    /** registerHook */\n    this.registerHook = hookMeta => {\n      if (this.hookMap.has(hookMeta.name)) {\n        console.error(`${hookMeta.name} is duplicated in hookmap`);\n      }\n      this.hookMap.set(hookMeta.name, hookMeta);\n      return {\n        dispose: () => {\n          this.hookMap.delete(hookMeta.name);\n        }\n      };\n    };\n    /** registerHook */\n    this.call = (args, main = mainArgs => __awaiter(this, void 0, void 0, function* () {\n      return mainArgs;\n    }), runtimeHook = []) => __awaiter(this, void 0, void 0, function* () {\n      // TODO: 这里加cache\n      const hooks = this.getHooks(runtimeHook, true);\n      const scheduler = this.schedulers[this.scheduleType];\n      return scheduler(args, main, hooks);\n    });\n    /** 执行hook的scheduler */\n    this.schedulers = {\n      /** pipeline执行 */\n      [ScheduleTypeEnum.ASYNC_SRRIES]: (args, main, hooks = []) => __awaiter(this, void 0, void 0, function* () {\n        let callback = main;\n        /** 用 hook 加工 args  */\n        for (const hook of hooks) {\n          if ([0, 1].includes(hook.handler.length)) {\n            yield hook.handler.call(this, args);\n            continue;\n          }\n          if ([2].includes(hook.handler.length) && callback !== null) {\n            // eslint-disable-next-line @typescript-eslint/no-shadow\n            const result = yield hook.handler.call(this, args, callback);\n            /** 如果返回为null，则直接中断执行 */\n            if (result === null) {\n              callback = null;\n              break;\n            } else if (typeof result === 'function') {\n              callback = result;\n              continue;\n            }\n          }\n          const err = ErrorUtils.InvalidHookArguments(hook);\n          throw err;\n        }\n        /** 检查是否被替换为null */\n        if (callback) {\n          return yield callback.call(this, args);\n        }\n      }),\n      [ScheduleTypeEnum.ASYNC_PARALLEL]: (args, main, hooks = []) => __awaiter(this, void 0, void 0, function* () {\n        /** 同时触发 hook */\n        const promises = hooks.map(hook => {\n          if ([0, 1].includes(hook.handler.length)) {\n            return hook.handler.call(this, args);\n          }\n          if ([2].includes(hook.handler.length)) {\n            return hook.handler.call(this, args, main);\n          }\n          throw ErrorUtils.InvalidHookArguments(hook);\n        });\n        const defer = new Deferred();\n        Promise.all(promises).then(res => defer.resolve(res));\n        /** 检查是否被替换 */\n        if (main) {\n          return yield main.call(this, defer);\n        }\n      })\n    };\n    this.hookMap = new Map();\n    if (options && options.type) {\n      this.scheduleType = options.type;\n    }\n  }\n}","map":{"version":3,"names":["ScheduleTypeEnum","ErrorUtils","HookUtils","Deferred","HookHub","constructor","options","scheduleType","ASYNC_SRRIES","hasHook","hookName","hookMap","has","getHooks","runtimeHooks","sort","hooks","normalize","registerHook","hookMeta","name","console","error","set","dispose","delete","call","args","main","mainArgs","__awaiter","runtimeHook","scheduler","schedulers","callback","hook","includes","handler","length","result","err","InvalidHookArguments","ASYNC_PARALLEL","promises","map","defer","Promise","all","then","res","resolve","Map","type"],"sources":["../src/index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}