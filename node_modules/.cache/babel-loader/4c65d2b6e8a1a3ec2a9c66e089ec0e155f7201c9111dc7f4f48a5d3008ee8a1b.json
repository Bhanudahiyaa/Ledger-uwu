{"ast":null,"code":"import toposort from 'toposort';\nexport var ErrorUtils;\n(function (ErrorUtils) {\n  let ErrorEnum;\n  (function (ErrorEnum) {\n    ErrorEnum[\"INVALID_HOOK_BEFORE\"] = \"INVALID_HOOK_BEFORE\";\n    ErrorEnum[\"INVALID_HOOK_AFTER\"] = \"INVALID_HOOK_AFTER\";\n    ErrorEnum[\"INVALID_HOOK_ARGS_LENGTH\"] = \"INVALID_HOOK_ARGS_LENGTH\";\n  })(ErrorEnum = ErrorUtils.ErrorEnum || (ErrorUtils.ErrorEnum = {}));\n  class HookError extends Error {\n    constructor(code, message, ...contexts) {\n      if (Array.isArray(message)) {\n        message = message.filter(function (line) {\n          return !!line;\n        }).join(' ');\n      }\n      super(`${code}: ${message}`);\n      if (Error.captureStackTrace) {\n        ;\n        Error.captureStackTrace(this, HookError);\n      }\n      this.code = code;\n      this.contexts = {};\n      contexts.forEach(context => {\n        if (typeof context === 'object') {\n          Object.entries(context).forEach(pair => {\n            const [key, value] = pair;\n            if (key !== 'key' && value) {\n              this.contexts[key] = JSON.parse(JSON.stringify(value));\n            }\n          });\n        }\n      });\n    }\n    toString() {\n      return `${this.code}: ${this.message}`;\n    }\n  }\n  ErrorUtils.HookError = HookError;\n  const createError = (code, message, ...args) => {\n    return new HookError(code, message, ...args);\n  };\n  ErrorUtils.HookBeforeError = () => {\n    return createError(ErrorEnum.INVALID_HOOK_BEFORE, ['hook require a before dependency but not exist in hookmap']);\n  };\n  ErrorUtils.HookAfterError = () => {\n    return createError(ErrorEnum.INVALID_HOOK_AFTER, ['hook require a after dependency but not exist in hookmap']);\n  };\n  ErrorUtils.InvalidHookArguments = hook => {\n    return createError(ErrorEnum.INVALID_HOOK_ARGS_LENGTH, ['hook handlers must have 0 to 2 arguments', `but got ${hook.handler.length}`]);\n  };\n})(ErrorUtils || (ErrorUtils = {}));\nexport var HookUtils;\n(function (HookUtils) {\n  /** 处理 runtime hooks */\n  HookUtils.normalize = (hookConfig = [], hookMap) => {\n    const runtimeHook = Array.isArray(hookConfig) ? hookConfig : [hookConfig];\n    const innerHooks = [];\n    hookMap.forEach(val => {\n      innerHooks.push(val);\n    });\n    return [...innerHooks, ...runtimeHook].filter(item => item && !!item.handler);\n  };\n  /** 排序 hooks */\n  HookUtils.sort = (hooks = [], hookMap) => {\n    const edges = [];\n    hooks.forEach(hook => {\n      if (hook.before) {\n        if (!hookMap.has(hook.before)) {\n          throw ErrorUtils.HookBeforeError();\n        }\n        const edge = [hook, hookMap.get(hook.before)];\n        edges.push(edge);\n      }\n      if (hook.after) {\n        if (!hookMap.has(hook.after)) {\n          throw ErrorUtils.HookBeforeError();\n        }\n        const edge = [hookMap.get(hook.after), hook];\n        edges.push(edge);\n      }\n    });\n    const sortedHooks = toposort.array(hooks, edges);\n    return sortedHooks;\n  };\n})(HookUtils || (HookUtils = {}));\nexport class Deferred {\n  constructor() {\n    this.isResolved = false;\n    this.isRejected = false;\n    this.promise = new Promise((resolve, reject) => {\n      this.resolve = args => {\n        this.isResolved = true;\n        resolve(args);\n      };\n      this.reject = args => {\n        this.isRejected = true;\n        reject(args);\n      };\n    });\n  }\n}","map":{"version":3,"names":["toposort","ErrorUtils","ErrorEnum","HookError","Error","constructor","code","message","contexts","Array","isArray","filter","line","join","captureStackTrace","forEach","context","Object","entries","pair","key","value","JSON","parse","stringify","toString","createError","args","HookBeforeError","INVALID_HOOK_BEFORE","HookAfterError","INVALID_HOOK_AFTER","InvalidHookArguments","hook","INVALID_HOOK_ARGS_LENGTH","handler","length","HookUtils","normalize","hookConfig","hookMap","runtimeHook","innerHooks","val","push","item","sort","hooks","edges","before","has","edge","get","after","sortedHooks","array","Deferred","isResolved","isRejected","promise","Promise","resolve","reject"],"sources":["../src/utils.ts"],"sourcesContent":[null],"mappings":"AACA,OAAOA,QAAQ,MAAM,UAAU;AAE/B,OAAM,IAAWC,UAAU;AAA3B,WAAiBA,UAAU;EACzB,IAAYC,SAIX;EAJD,WAAYA,SAAS;IACnBA,SAAA,+CAA6C;IAC7CA,SAAA,6CAA2C;IAC3CA,SAAA,yDAAuD;EACzD,CAAC,EAJWA,SAAS,GAATD,UAAA,CAAAC,SAAS,KAATD,UAAA,CAAAC,SAAS;EAMrB,MAAaC,SAAU,SAAQC,KAAK;IAGlCC,YAAYC,IAAY,EAAEC,OAA0B,EAAE,GAAGC,QAAe;MACtE,IAAIC,KAAK,CAACC,OAAO,CAACH,OAAO,CAAC,EAAE;QAC1BA,OAAO,GAAGA,OAAO,CACdI,MAAM,CAAC,UAAUC,IAAI;UACpB,OAAO,CAAC,CAACA,IAAI;QACf,CAAC,CAAC,CACDC,IAAI,CAAC,GAAG,CAAC;;MAEd,KAAK,CAAC,GAAGP,IAAI,KAAKC,OAAO,EAAE,CAAC;MAC5B,IAAKH,KAAa,CAACU,iBAAiB,EAAE;QACpC;QAAEV,KAAa,CAACU,iBAAiB,CAAC,IAAI,EAAEX,SAAS,CAAC;;MAEpD,IAAI,CAACG,IAAI,GAAGA,IAAI;MAChB,IAAI,CAACE,QAAQ,GAAG,EAAE;MAClBA,QAAQ,CAACO,OAAO,CAACC,OAAO,IAAG;QACzB,IAAI,OAAOA,OAAO,KAAK,QAAQ,EAAE;UAC/BC,MAAM,CAACC,OAAO,CAACF,OAAO,CAAC,CAACD,OAAO,CAACI,IAAI,IAAG;YACrC,MAAM,CAACC,GAAG,EAAEC,KAAK,CAAC,GAAGF,IAAI;YACzB,IAAIC,GAAG,KAAK,KAAK,IAAIC,KAAK,EAAE;cAC1B,IAAI,CAACb,QAAQ,CAACY,GAAG,CAAC,GAAGE,IAAI,CAACC,KAAK,CAACD,IAAI,CAACE,SAAS,CAACH,KAAK,CAAC,CAAC;;UAE1D,CAAC,CAAC;;MAEN,CAAC,CAAC;IACJ;IACAI,QAAQA,CAAA;MACN,OAAO,GAAG,IAAI,CAACnB,IAAI,KAAK,IAAI,CAACC,OAAO,EAAE;IACxC;;EA9BWN,UAAA,CAAAE,SAAS,GAAAA,SA+BrB;EACD,MAAMuB,WAAW,GAAGA,CAACpB,IAAY,EAAEC,OAAiB,EAAE,GAAGoB,IAAW,KAAI;IACtE,OAAO,IAAIxB,SAAS,CAACG,IAAI,EAAEC,OAAO,EAAE,GAAGoB,IAAI,CAAC;EAC9C,CAAC;EACY1B,UAAA,CAAA2B,eAAe,GAAG,MAAK;IAClC,OAAOF,WAAW,CAACxB,SAAS,CAAC2B,mBAAmB,EAAE,CAChD,2DAA2D,CAC5D,CAAC;EACJ,CAAC;EACY5B,UAAA,CAAA6B,cAAc,GAAG,MAAK;IACjC,OAAOJ,WAAW,CAACxB,SAAS,CAAC6B,kBAAkB,EAAE,CAC/C,0DAA0D,CAC3D,CAAC;EACJ,CAAC;EACY9B,UAAA,CAAA+B,oBAAoB,GAAIC,IAAW,IAAI;IAClD,OAAOP,WAAW,CAACxB,SAAS,CAACgC,wBAAwB,EAAE,CACrD,0CAA0C,EAC1C,WAAWD,IAAI,CAACE,OAAO,CAACC,MAAM,EAAE,CACjC,CAAC;EACJ,CAAC;AACH,CAAC,EA1DgBnC,UAAU,KAAVA,UAAU;AA4D3B,OAAM,IAAWoC,SAAS;AAA1B,WAAiBA,SAAS;EACxB;EACaA,SAAA,CAAAC,SAAS,GAAG,CACvBC,UAAA,GAA8B,EAAE,EAChCC,OAA2B,KAChB;IACX,MAAMC,WAAW,GAAGhC,KAAK,CAACC,OAAO,CAAC6B,UAAU,CAAC,GAAGA,UAAU,GAAG,CAACA,UAAU,CAAC;IACzE,MAAMG,UAAU,GAAY,EAAE;IAC9BF,OAAO,CAACzB,OAAO,CAAC4B,GAAG,IAAG;MACpBD,UAAU,CAACE,IAAI,CAACD,GAAG,CAAC;IACtB,CAAC,CAAC;IAEF,OAAO,CAAC,GAAGD,UAAU,EAAE,GAAGD,WAAW,CAAC,CAAC9B,MAAM,CAACkC,IAAI,IAAIA,IAAI,IAAI,CAAC,CAACA,IAAI,CAACV,OAAO,CAAC;EAC/E,CAAC;EACD;EACaE,SAAA,CAAAS,IAAI,GAAG,CAACC,KAAA,GAAiB,EAAE,EAAEP,OAA2B,KAAa;IAChF,MAAMQ,KAAK,GAAqB,EAAE;IAClCD,KAAK,CAAChC,OAAO,CAACkB,IAAI,IAAG;MACnB,IAAIA,IAAI,CAACgB,MAAM,EAAE;QACf,IAAI,CAACT,OAAO,CAACU,GAAG,CAACjB,IAAI,CAACgB,MAAM,CAAC,EAAE;UAC7B,MAAMhD,UAAU,CAAC2B,eAAe,EAAE;;QAEpC,MAAMuB,IAAI,GAAG,CAAClB,IAAI,EAAEO,OAAO,CAACY,GAAG,CAACnB,IAAI,CAACgB,MAAM,CAAC,CAAmB;QAC/DD,KAAK,CAACJ,IAAI,CAACO,IAAI,CAAC;;MAElB,IAAIlB,IAAI,CAACoB,KAAK,EAAE;QACd,IAAI,CAACb,OAAO,CAACU,GAAG,CAACjB,IAAI,CAACoB,KAAK,CAAC,EAAE;UAC5B,MAAMpD,UAAU,CAAC2B,eAAe,EAAE;;QAEpC,MAAMuB,IAAI,GAAG,CAACX,OAAO,CAACY,GAAG,CAACnB,IAAI,CAACoB,KAAK,CAAC,EAAEpB,IAAI,CAAmB;QAC9De,KAAK,CAACJ,IAAI,CAACO,IAAI,CAAC;;IAEpB,CAAC,CAAC;IACF,MAAMG,WAAW,GAAGtD,QAAQ,CAACuD,KAAK,CAACR,KAAK,EAAEC,KAAK,CAAC;IAChD,OAAOM,WAAW;EACpB,CAAC;AACH,CAAC,EApCgBjB,SAAS,KAATA,SAAS;AAsC1B,OAAM,MAAOmB,QAAQ;EAWnBnD,YAAA;IAVA,KAAAoD,UAAU,GAAY,KAAK;IAE3B,KAAAC,UAAU,GAAY,KAAK;IASzB,IAAI,CAACC,OAAO,GAAG,IAAIC,OAAO,CAAI,CAACC,OAAO,EAAEC,MAAM,KAAI;MAChD,IAAI,CAACD,OAAO,GAAGlC,IAAI,IAAG;QACpB,IAAI,CAAC8B,UAAU,GAAG,IAAI;QACtBI,OAAO,CAAClC,IAAI,CAAC;MACf,CAAC;MACD,IAAI,CAACmC,MAAM,GAAGnC,IAAI,IAAG;QACnB,IAAI,CAAC+B,UAAU,GAAG,IAAI;QACtBI,MAAM,CAACnC,IAAI,CAAC;MACd,CAAC;IACH,CAAC,CAAC;EACJ","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}