{"ast":null,"code":"import Grid from './grid';\nexport default function layout(data, options) {\n  if (!data.nodes || data.nodes.length === 0) return data;\n  const width = options.width;\n  const height = options.height;\n  const nodeMinGap = options.nodeMinGap;\n  // 2. 网格布局\n  let CELL_W = 10000;\n  let CELL_H = 10000;\n  data.nodes.forEach(node => {\n    const nodeWidth = node.size[0] || 50;\n    const nodeHeight = node.size[1] || 50;\n    CELL_W = Math.min(nodeWidth, CELL_W);\n    CELL_H = Math.min(nodeHeight, CELL_H);\n  });\n  const grid = new Grid();\n  grid.init(width, height, {\n    CELL_H,\n    CELL_W\n  });\n  data.nodes.forEach(d => {\n    const gridpoint = grid.occupyNearest(d);\n    if (gridpoint) {\n      gridpoint.node = {\n        id: d.id,\n        size: d.size\n      };\n      d.x = gridpoint.x;\n      d.y = gridpoint.y;\n      d.dx = gridpoint.dx;\n      d.dy = gridpoint.dy;\n    }\n  });\n  // 加入节点size\n  for (let i = 0; i < data.nodes.length; i++) {\n    //  节点宽度大于网格宽度，则往当前网格的右边插入列\n    const node = data.nodes[i];\n    const result = grid.findGridByNodeId(node.id);\n    if (!result) throw new Error(\"can not find node cell\");\n    const {\n      column,\n      row\n    } = result;\n    if (node.size[0] + nodeMinGap > CELL_W) {\n      const addGridSize = Math.ceil((node.size[0] + nodeMinGap) / CELL_W) - 1;\n      let realAdd = addGridSize;\n      // 优化，假设同一列，不同行存在两个size为2的节点，遍历到第一个节点的时候，会往右插入两列，遍历到第二个节点，又往右插入。就会导致多余的网格\n      for (let j = 0; j < addGridSize; j++) {\n        const hasColumn = grid.additionColumn.indexOf(column + j + 1) > -1;\n        if (hasColumn && !grid.cells[column + j + 1][row].node) {\n          realAdd--;\n        } else {\n          break;\n        }\n      }\n      grid.insertColumn(column, realAdd);\n    }\n    // 节点高度大于网格宽度，则往当前网格的下边插入行\n    if (node.size[1] + nodeMinGap > CELL_H) {\n      const addGridSize = Math.ceil((node.size[1] + nodeMinGap) / CELL_H) - 1;\n      let realAdd = addGridSize;\n      for (let j = 0; j < addGridSize; j++) {\n        const hasColumn = grid.additionRow.indexOf(row + j + 1) > -1;\n        if (hasColumn && !grid.cells[column][row + j + 1].node) {\n          realAdd--;\n        } else {\n          break;\n        }\n      }\n      grid.insertRow(row, realAdd);\n    }\n  }\n  // 同步节点坐标\n  for (let i = 0; i < grid.columnNum; i++) {\n    for (let j = 0; j < grid.rowNum; j++) {\n      const cell = grid.cells[i][j];\n      if (cell.node) {\n        const node = data.nodes.find(node => {\n          var _a;\n          return node.id === ((_a = cell === null || cell === void 0 ? void 0 : cell.node) === null || _a === void 0 ? void 0 : _a.id);\n        });\n        if (node) {\n          node.x = cell.x + node.size[0] / 2;\n          node.y = cell.y + node.size[1] / 2;\n        }\n      }\n    }\n  }\n}","map":{"version":3,"names":["Grid","layout","data","options","nodes","length","width","height","nodeMinGap","CELL_W","CELL_H","forEach","node","nodeWidth","size","nodeHeight","Math","min","grid","init","d","gridpoint","occupyNearest","id","x","y","dx","dy","i","result","findGridByNodeId","Error","column","row","addGridSize","ceil","realAdd","j","hasColumn","additionColumn","indexOf","cells","insertColumn","additionRow","insertRow","columnNum","rowNum","cell","find","_a"],"sources":["../../../src/layout/er/forceGrid.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}