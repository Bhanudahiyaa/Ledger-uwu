{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport React from 'react';\nimport classNames from 'classnames';\n/** app */\nimport { initApp } from '../application-module';\nimport { XFlowAppInternalProvider, useXFlowApp } from './app-context';\n/** app-extension */\nimport { ExtensionRegistryContext } from './extension-context';\nimport { useXflowPrefixCls } from './global-config-context';\nimport { XFlowAppExtensionModule } from './app-extension-module';\nimport { ExtensionRegistry, createExtensionRegistry } from './extension-registry';\n/** graph */\nimport { XFlowCanvas } from './canvas';\n/** command */\nimport { ModelServiceRegistry } from '../../model-service';\nimport { CommandsRegistry, XFlowGraphCommands } from '../../command-contributions';\n/** hook */\nimport { HookRegistry } from '../../hooks';\n/** UI model */\nimport { ToolbarRegistry } from '../../toolbar';\nimport { MenuRegistry } from '../../menu';\nexport const XFlow = props => {\n  const {\n    meta,\n    graphConfig,\n    graphData,\n    graphLayout,\n    onLoad,\n    isAutoCenter,\n    hookConfig,\n    modelServiceConfig,\n    commandConfig,\n    onAppConfigReady,\n    onAppDestroy,\n    children = [],\n    className,\n    style\n  } = props;\n  const [appRef, setAppRef] = React.useState();\n  /** 所有组件父容器 */\n  const appContainerRef = React.useRef(null);\n  /** XFlow App 配置中心 */\n  const extensionRegistry = createExtensionRegistry();\n  /** didMount */\n  React.useEffect(() => {\n    /** before app start */\n    if (onAppConfigReady) {\n      onAppConfigReady(extensionRegistry);\n    }\n    /** 初始化应用 */\n    const app = initApp(extensionRegistry);\n    app.start().then(() => __awaiter(void 0, void 0, void 0, function* () {\n      var _a;\n      /** 保留引用 */\n      setAppRef(app);\n      (_a = extensionRegistry.getExtension('GraphConfig')) === null || _a === void 0 ? void 0 : _a.config.setAppContainer(appContainerRef.current);\n      /** 自动执行 load Meta */\n      if (meta) {\n        yield app.commandService.executeCommand(XFlowGraphCommands.LOAD_META.id, {\n          meta\n        });\n      }\n      /** after app start */\n      if (onLoad) {\n        onLoad(app, extensionRegistry);\n      }\n      if (graphData) {\n        if (graphLayout) {\n          yield app.commandService.executeCommand(XFlowGraphCommands.GRAPH_LAYOUT.id, Object.assign({\n            graphData\n          }, graphLayout));\n        }\n        yield app.commandService.executeCommand(XFlowGraphCommands.GRAPH_RENDER.id, {\n          graphData\n        });\n      }\n    }));\n    /** unmount */\n    const destroy = () => __awaiter(void 0, void 0, void 0, function* () {\n      onAppDestroy && onAppDestroy(app);\n    });\n    return () => {\n      destroy();\n    };\n    /** 不要删 保证只生成一次 */\n    // eslint-disable-next-line\n  }, []);\n  /** 自动更新meta */\n  React.useEffect(() => {\n    if (appRef) {\n      appRef.commandService.executeCommand(XFlowGraphCommands.LOAD_META.id, {\n        meta\n      });\n    }\n    /** 不要删 只和meta联动 */\n    // eslint-disable-next-line\n  }, [meta]);\n  /** 自动渲染画布内容 */\n  React.useEffect(() => {\n    const fn = () => __awaiter(void 0, void 0, void 0, function* () {\n      if (appRef) {\n        if (graphData && graphLayout) {\n          yield appRef.commandService.executeCommand(XFlowGraphCommands.GRAPH_LAYOUT.id, Object.assign({\n            graphData\n          }, graphLayout));\n        }\n        yield appRef.commandService.executeCommand(XFlowGraphCommands.GRAPH_RENDER.id, {\n          graphData\n        });\n        /** 自动居中画布内容 */\n        if (isAutoCenter) {\n          const x6Graph = yield appRef.getGraphInstance();\n          x6Graph.centerContent();\n        }\n      }\n    });\n    fn();\n    /** 不要删 只和graphData联动 */\n    // eslint-disable-next-line\n  }, [graphData]);\n  /** classname */\n  const appClzName = classNames('xflow-app-workspace', className, ...extensionRegistry.getContainerClassNames());\n  /** 判断是否需要自动渲染画布组件, 坐标相对于xflow-graph-root */\n  const hasCanvasComponent = (Array.isArray(children) ? children : [children]).some(child => {\n    return child && child.props.isXFlowCanvas;\n  });\n  return React.createElement(XFlowAppInternalProvider, {\n    app: appRef\n  }, React.createElement(ExtensionRegistryContext.Provider, {\n    value: extensionRegistry\n  }, React.createElement(\"div\", {\n    className: appClzName,\n    id: extensionRegistry.getInstanceId(),\n    ref: appContainerRef,\n    style: style\n  }, !hasCanvasComponent && React.createElement(XFlowCanvas, {\n    config: graphConfig,\n    position: {\n      top: 0,\n      bottom: 0,\n      left: 0,\n      right: 0\n    }\n  }), children, React.createElement(ModelServiceRegistry, {\n    config: modelServiceConfig\n  }), React.createElement(CommandsRegistry, {\n    config: commandConfig\n  }), React.createElement(HookRegistry, {\n    config: hookConfig\n  }), React.createElement(ToolbarRegistry, null), React.createElement(MenuRegistry, null))));\n};\nXFlow.defaultProps = {};\nexport default XFlow;\nexport { useXFlowApp, useXflowPrefixCls, XFlowCanvas, XFlowAppExtensionModule as XFlowAppExtension, ExtensionRegistry };","map":{"version":3,"names":["React","classNames","initApp","XFlowAppInternalProvider","useXFlowApp","ExtensionRegistryContext","useXflowPrefixCls","XFlowAppExtensionModule","ExtensionRegistry","createExtensionRegistry","XFlowCanvas","ModelServiceRegistry","CommandsRegistry","XFlowGraphCommands","HookRegistry","ToolbarRegistry","MenuRegistry","XFlow","props","meta","graphConfig","graphData","graphLayout","onLoad","isAutoCenter","hookConfig","modelServiceConfig","commandConfig","onAppConfigReady","onAppDestroy","children","className","style","appRef","setAppRef","useState","appContainerRef","useRef","extensionRegistry","useEffect","app","start","then","__awaiter","_a","getExtension","config","setAppContainer","current","commandService","executeCommand","LOAD_META","id","GRAPH_LAYOUT","Object","assign","GRAPH_RENDER","destroy","fn","x6Graph","getGraphInstance","centerContent","appClzName","getContainerClassNames","hasCanvasComponent","Array","isArray","some","child","isXFlowCanvas","createElement","Provider","value","getInstanceId","ref","position","top","bottom","left","right","defaultProps","XFlowAppExtension"],"sources":["../../../src/xflow-main/components/index.tsx"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}