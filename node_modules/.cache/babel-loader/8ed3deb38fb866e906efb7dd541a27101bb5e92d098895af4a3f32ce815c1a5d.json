{"ast":null,"code":"import { Marker } from '@antv/l7';\nimport EventEmitter from '@antv/event-emitter';\nimport { isString, isEqual } from '@antv/util';\nimport { Tooltip as TooltipComponent } from '@antv/l7plot-component';\nimport { get as getValueByPath } from 'lodash-es';\nimport { TooltipAnchorType } from '../types';\nimport { deepAssign } from '../utils';\nconst TRIGGER_LIST = ['mousemove', 'click'];\nexport class Tooltip extends EventEmitter {\n  constructor(scene, interactionLayers, options) {\n    super();\n    /**\n     * tooltip 是否可见\n     */\n    this.currentVisible = false;\n    this.interactionTriggerHander = event => {\n      const {\n        feature,\n        featureId\n      } = event;\n      const {\n        title,\n        customTitle,\n        items,\n        customItems\n      } = this.options;\n      // is GeoJson type\n      const isGeoFeature = feature.type === 'Feature' && feature.geometry && feature.properties;\n      // parse GeoJson properties\n      const properties = isGeoFeature ? feature.properties : feature;\n      let tooltipItems = [];\n      if (customItems) {\n        const items = customItems(feature);\n        if (Array.isArray(items)) {\n          tooltipItems = items;\n        } else {\n          throw new Error('customItems return array');\n        }\n      } else if (items) {\n        items.forEach(item => {\n          if (isString(item)) {\n            const name = item.split('.').pop() || item;\n            const value = getValueByPath(properties, item);\n            if (value !== undefined) {\n              tooltipItems.push({\n                name,\n                value\n              });\n            }\n          } else {\n            const {\n              field,\n              alias,\n              customValue\n            } = item;\n            const name = alias || field.split('.').pop() || field;\n            const value = getValueByPath(properties, field);\n            if (value !== undefined) {\n              tooltipItems.push({\n                name,\n                value: customValue ? customValue(value, properties, featureId) : value\n              });\n            }\n          }\n        });\n      }\n      const componentOptions = {\n        title: customTitle ? customTitle(properties) : title,\n        items: tooltipItems\n      };\n      this.updateTooltip(event, componentOptions);\n    };\n    this.interactionUntriggerHander = () => {\n      this.hideTooltip();\n    };\n    this.scene = scene;\n    this.interactionLayers = interactionLayers;\n    this.options = deepAssign({}, this.getDefaultOptions(), options);\n    const {\n      offsets,\n      title,\n      showTitle,\n      customContent,\n      domStyles,\n      anchor,\n      className\n    } = this.options;\n    this.marker = new Marker({\n      offsets,\n      anchor,\n      draggable: false\n    });\n    this.tooltipComponent = new TooltipComponent({\n      title,\n      showTitle,\n      items: [],\n      customContent,\n      domStyles,\n      className\n    });\n    this.setComponent();\n    this.initInteractionEvent();\n  }\n  /**\n   * 获取默认配置\n   */\n  getDefaultOptions() {\n    return {\n      showTitle: true,\n      showComponent: true,\n      items: [],\n      offsets: [15, 0],\n      trigger: 'mousemove',\n      anchor: TooltipAnchorType['TOP-LEFT']\n    };\n  }\n  /**\n   * 更新 tooltip 组件\n   */\n  update(options) {\n    this.marker.remove();\n    this.currentVisible = false;\n    this.options = deepAssign({}, this.options, options);\n    const {\n      offsets,\n      showTitle,\n      customContent,\n      domStyles,\n      anchor,\n      className\n    } = this.options;\n    this.marker = new Marker({\n      offsets,\n      anchor,\n      draggable: false\n    });\n    this.tooltipComponent.update({\n      showTitle,\n      customContent,\n      domStyles,\n      className\n    });\n    this.setComponent();\n  }\n  initInteractionEvent() {\n    const trigger = this.options.trigger || 'mousemove';\n    if (!TRIGGER_LIST.includes(trigger)) {\n      throw new Error('trigger is mousemove or click');\n    }\n    this.interactionLayers.forEach(({\n      layer\n    }) => {\n      layer.on(trigger, this.interactionTriggerHander);\n      layer.on(`un${trigger}`, this.interactionUntriggerHander);\n    });\n  }\n  unBindInteractionEvent() {\n    const trigger = this.options.trigger || 'mousemove';\n    this.interactionLayers.forEach(({\n      layer\n    }) => {\n      layer.off(trigger, this.interactionTriggerHander);\n      layer.off(`un${trigger}`, this.interactionUntriggerHander);\n    });\n  }\n  updateTooltip(mouseEvent, componentOptions) {\n    const {\n      lngLat,\n      x,\n      y\n    } = mouseEvent;\n    if (this.options.showComponent) {\n      this.updateComponent(componentOptions);\n      this.setPostion(lngLat);\n    }\n    if (this.currentVisible) {\n      const event = {\n        type: 'tooltip:change',\n        data: componentOptions,\n        lngLat,\n        x,\n        y\n      };\n      this.emit('tooltip:change', event);\n    } else {\n      this.showTooltip();\n      const event = {\n        type: 'tooltip:show',\n        data: componentOptions,\n        lngLat,\n        x,\n        y\n      };\n      this.emit('tooltip:show', event);\n    }\n  }\n  /**\n   * tooltip 添加到地图上\n   */\n  showTooltip() {\n    if (this.currentVisible) return;\n    if (this.options.showComponent) {\n      this.scene.addMarker(this.marker);\n    }\n    this.currentVisible = true;\n  }\n  /**\n   * tooltip 从地图上移除\n   */\n  hideTooltip() {\n    if (!this.currentVisible) return;\n    if (this.options.showComponent) {\n      this.marker.remove();\n    }\n    this.currentVisible = false;\n    const event = {\n      type: 'tooltip:hide'\n    };\n    this.emit('tooltip:hide', event);\n  }\n  /**\n   * 更新 tooltip 组件\n   */\n  updateComponent(componentOptions) {\n    if (!isEqual(this.lastComponentOptions, componentOptions)) {\n      this.tooltipComponent.update(componentOptions);\n      this.lastComponentOptions = componentOptions;\n    }\n  }\n  /**\n   * 设置 tooltip 内容\n   */\n  setComponent() {\n    const tooltip = this.tooltipComponent.getContainer();\n    const container = window.document.createElement('div');\n    container.style.cursor = 'auto';\n    container.style.userSelect = 'text';\n    container.className = 'l7plot-tooltip-container';\n    // stopPropagation\n    ['mousemove', 'mousedown', 'mouseup', 'click', 'dblclick'].forEach(type => {\n      container.addEventListener(type, e => e.stopPropagation());\n    });\n    container.appendChild(tooltip);\n    this.marker.setElement(container);\n  }\n  /**\n   * 设置 tooltip 位置\n   */\n  setPostion(position) {\n    this.marker.setLnglat(position);\n  }\n  /**\n   * 销毁\n   */\n  destroy() {\n    this.unBindInteractionEvent();\n    this.off();\n    this.marker.remove();\n    this.tooltipComponent.destroy();\n  }\n}","map":{"version":3,"names":["Marker","EventEmitter","isString","isEqual","Tooltip","TooltipComponent","get","getValueByPath","TooltipAnchorType","deepAssign","TRIGGER_LIST","constructor","scene","interactionLayers","options","currentVisible","interactionTriggerHander","event","feature","featureId","title","customTitle","items","customItems","isGeoFeature","type","geometry","properties","tooltipItems","Array","isArray","Error","forEach","item","name","split","pop","value","undefined","push","field","alias","customValue","componentOptions","updateTooltip","interactionUntriggerHander","hideTooltip","getDefaultOptions","offsets","showTitle","customContent","domStyles","anchor","className","marker","draggable","tooltipComponent","setComponent","initInteractionEvent","showComponent","trigger","update","remove","includes","layer","on","unBindInteractionEvent","off","mouseEvent","lngLat","x","y","updateComponent","setPostion","data","emit","showTooltip","addMarker","lastComponentOptions","tooltip","getContainer","container","window","document","createElement","style","cursor","userSelect","addEventListener","e","stopPropagation","appendChild","setElement","position","setLnglat","destroy"],"sources":["../../../src/component/tooltip.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}