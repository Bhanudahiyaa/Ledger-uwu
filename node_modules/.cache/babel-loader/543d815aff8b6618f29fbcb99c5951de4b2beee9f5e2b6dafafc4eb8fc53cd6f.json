{"ast":null,"code":"import { getJudgeFunction } from '../fn';\nimport { requestAnimationFrame } from './animationFrame';\nexport class TouchHandler {\n  constructor(options) {\n    this.didTouchMove = () => {\n      // Fire scroll callback based on computed drag delta.\n      // Also track accummulated delta so we can calculate velocity\n      this.dragAnimationId = null;\n      this.callback(this.deltaX, this.deltaY);\n      this.accumulatedDeltaX += this.deltaX;\n      this.accumulatedDeltaY += this.deltaY;\n      this.deltaX = 0;\n      this.deltaY = 0;\n    };\n    this.track = () => {\n      // Compute velocity based on a weighted average of drag over\n      // last 100ms and previous velocity. Combining into a moving average\n      // results in a smoother scroll.\n      const now = Date.now();\n      const elapsed = now - this.lastFrameTimestamp;\n      const oldVelocityX = this.velocityX;\n      const oldVelocityY = this.velocityY;\n      // We compute velocity using a weighted average of the current\n      // velocity and the previous velocity. If the previous velocity\n      // is 0, put the full weight on the last 100ms\n      let weight = 0.8;\n      if (elapsed < TouchHandler.TRACKER_TIMEOUT) {\n        weight *= elapsed / TouchHandler.TRACKER_TIMEOUT;\n      }\n      if (oldVelocityX === 0 && oldVelocityY === 0) {\n        weight = 1;\n      }\n      // Formula for computing weighted average of velocity\n      this.velocityX = weight * (TouchHandler.TRACKER_TIMEOUT * this.accumulatedDeltaX / (1 + elapsed));\n      if (weight < 1) {\n        this.velocityX += (1 - weight) * oldVelocityX;\n      }\n      this.velocityY = weight * (TouchHandler.TRACKER_TIMEOUT * this.accumulatedDeltaY / (1 + elapsed));\n      if (weight < 1) {\n        this.velocityY += (1 - weight) * oldVelocityY;\n      }\n      this.accumulatedDeltaX = 0;\n      this.accumulatedDeltaY = 0;\n      this.lastFrameTimestamp = now;\n    };\n    this.startAutoScroll = () => {\n      // To kick off deceleration / momentum scrolling, handle any\n      // scrolling from a drag which was waiting for an animation\n      // frame. Then update our velocity.\n      // Finally start the momentum scrolling handler (autoScroll)\n      this.autoScrollTimestamp = Date.now();\n      if (this.deltaX > 0 || this.deltaY > 0) {\n        this.didTouchMove();\n      }\n      this.track();\n      this.autoScroll();\n    };\n    this.autoScroll = () => {\n      // Compute a scroll delta with an exponential decay based on\n      // time elapsed since drag was released. This is called\n      // recursively on animation frames until the delta is below\n      // a threshold (5 pixels)\n      const elapsed = Date.now() - this.autoScrollTimestamp;\n      const factor = TouchHandler.DECELERATION_AMPLITUDE * Math.exp(-elapsed / TouchHandler.DECELERATION_FACTOR);\n      let deltaX = factor * this.velocityX;\n      let deltaY = factor * this.velocityY;\n      if (Math.abs(deltaX) <= 5 || !this.handleScrollX(deltaX, deltaY)) {\n        deltaX = 0;\n      }\n      if (Math.abs(deltaY) <= 5 || !this.handleScrollY(deltaY, deltaX)) {\n        deltaY = 0;\n      }\n      if (deltaX !== 0 || deltaY !== 0) {\n        this.callback(deltaX, deltaY);\n        requestAnimationFrame(this.autoScroll);\n      }\n    };\n    this.trackerId = null;\n    this.dragAnimationId = null;\n    this.deltaX = 0;\n    this.deltaY = 0;\n    this.lastTouchX = 0;\n    this.lastTouchY = 0;\n    this.velocityX = 0;\n    this.velocityY = 0;\n    this.accumulatedDeltaX = 0;\n    this.accumulatedDeltaY = 0;\n    this.lastFrameTimestamp = Date.now();\n    this.autoScrollTimestamp = Date.now();\n    this.callback = options.onTouchScroll;\n    this.handleScrollX = getJudgeFunction(options.shouldHandleScrollX);\n    this.handleScrollY = getJudgeFunction(options.shouldHandleScrollY);\n    this.stopPropagation = getJudgeFunction(options.stopPropagation);\n  }\n  onTouchStart(e) {\n    this.lastTouchX = e.touches[0].pageX;\n    this.lastTouchY = e.touches[0].pageY;\n    this.velocityX = 0;\n    this.velocityY = 0;\n    this.accumulatedDeltaX = 0;\n    this.accumulatedDeltaY = 0;\n    this.lastFrameTimestamp = Date.now();\n    if (this.trackerId != null) {\n      clearInterval(this.trackerId);\n    }\n    this.trackerId = window.setInterval(this.track, TouchHandler.TRACKER_TIMEOUT);\n    if (this.stopPropagation()) {\n      e.stopPropagation();\n    }\n  }\n  onTouchEnd(e) {\n    this.onTouchCancel(e);\n    requestAnimationFrame(this.startAutoScroll);\n  }\n  onTouchCancel(e) {\n    if (this.trackerId != null) {\n      clearInterval(this.trackerId);\n      this.trackerId = null;\n    }\n    if (this.stopPropagation()) {\n      e.stopPropagation();\n    }\n  }\n  onTouchMove(e) {\n    const moveX = e.touches[0].pageX;\n    const moveY = e.touches[0].pageY;\n    // Compute delta scrolled since last drag\n    // Mobile, scrolling is inverted\n    this.deltaX = TouchHandler.MOVE_AMPLITUDE * (this.lastTouchX - moveX);\n    this.deltaY = TouchHandler.MOVE_AMPLITUDE * (this.lastTouchY - moveY);\n    const handleScrollX = this.handleScrollX(this.deltaX, this.deltaY);\n    const handleScrollY = this.handleScrollY(this.deltaY, this.deltaX);\n    if (!handleScrollX && !handleScrollY) {\n      return;\n    }\n    // If we can handle scroll update last touch for computing delta\n    if (handleScrollX) {\n      this.lastTouchX = moveX;\n    } else {\n      this.deltaX = 0;\n    }\n    if (handleScrollY) {\n      this.lastTouchY = moveY;\n    } else {\n      this.deltaY = 0;\n    }\n    e.preventDefault();\n    // ensure minimum delta magnitude is met to avoid jitter\n    let changed = false;\n    if (Math.abs(this.deltaX) > 2 || Math.abs(this.deltaY) > 2) {\n      if (this.stopPropagation()) {\n        e.stopPropagation();\n      }\n      changed = true;\n    }\n    // Request animation frame to trigger scroll of computed delta\n    if (changed && this.dragAnimationId == null) {\n      this.dragAnimationId = requestAnimationFrame(this.didTouchMove);\n    }\n  }\n}\n(function (TouchHandler) {\n  TouchHandler.MOVE_AMPLITUDE = 1.6;\n  TouchHandler.DECELERATION_AMPLITUDE = 1.6;\n  TouchHandler.DECELERATION_FACTOR = 325;\n  TouchHandler.TRACKER_TIMEOUT = 100;\n})(TouchHandler || (TouchHandler = {}));","map":{"version":3,"names":["getJudgeFunction","requestAnimationFrame","TouchHandler","constructor","options","didTouchMove","dragAnimationId","callback","deltaX","deltaY","accumulatedDeltaX","accumulatedDeltaY","track","now","Date","elapsed","lastFrameTimestamp","oldVelocityX","velocityX","oldVelocityY","velocityY","weight","TRACKER_TIMEOUT","startAutoScroll","autoScrollTimestamp","autoScroll","factor","DECELERATION_AMPLITUDE","Math","exp","DECELERATION_FACTOR","abs","handleScrollX","handleScrollY","trackerId","lastTouchX","lastTouchY","onTouchScroll","shouldHandleScrollX","shouldHandleScrollY","stopPropagation","onTouchStart","e","touches","pageX","pageY","clearInterval","window","setInterval","onTouchEnd","onTouchCancel","onTouchMove","moveX","moveY","MOVE_AMPLITUDE","preventDefault","changed"],"sources":["../../../src/util/dom/TouchHandler.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}